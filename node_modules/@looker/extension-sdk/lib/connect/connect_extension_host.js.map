{"version":3,"sources":["../../src/connect/connect_extension_host.ts"],"names":["connectExtensionHost","configuration","Promise","resolve","reject","initializationTimer","window","setTimeout","Error","initializedCallback","chattyTimeout","extensionHost","targetOrigin","initialized","initializationResponse","errorMessage","parent","location","origin","err","chattyHost","Chatty","createClient","on","ExtensionEvent","EXTENSION_HOST_NOTIFICATION","message","messageResponse","clearTimeout","undefined","handleNotification","error","withTargetOrigin","withDefaultTimeout","build","connect","ExtensionHostApiImpl"],"mappings":";;;;;;;AA0BA;;AACA;;AACA;;AAOA;;;;;;;;;;;;AAQO,IAAMA,oBAAoB;AAAA,+BAAG;AAAA,QAClCC,aADkC,uEACU,EADV;AAAA,WAIlC,IAAIC,OAAJ;AAAA,oCAAY,WAAOC,OAAP,EAAgBC,MAAhB,EAA2B;AAIrC,YAAIC,mBAAuC,GAAGC,MAAM,CAACC,UAAP,CAC5C,MACEH,MAAM,CAAC,IAAII,KAAJ,CAAU,oDAAV,CAAD,CAFoC,EAG5C,KAH4C,CAA9C;AAMA,YAAM;AAAEC,UAAAA,mBAAF;AAAuBC,UAAAA;AAAvB,YAAyCT,aAA/C;AACA,YAAIU,aAAJ;AACA,YAAIC,YAAJ;;AAIA,YAAMC,WAAW,GACfC,sBADkB,IAEf;AAGH,cAAIA,sBAAJ,EAA4B;AAG1B,gBAAM;AAAEC,cAAAA;AAAF,gBAAmBD,sBAAzB;;AACA,gBAAIL,mBAAJ,EAAyB;AACvBA,cAAAA,mBAAmB,CAACM,YAAD,CAAnB;AACD;;AACD,gBAAIA,YAAJ,EAAkB;AAChBX,cAAAA,MAAM,CAAC,IAAII,KAAJ,CAAUO,YAAV,CAAD,CAAN;AACD,aAFD,MAEO;AACLZ,cAAAA,OAAO,CAACQ,aAAD,CAAP;AACD;AACF,WAZD,MAYO;AACLP,YAAAA,MAAM,CAAC,IAAII,KAAJ,CAAU,yCAAV,CAAD,CAAN;AACD;AACF,SApBD;;AAqBA,YAAI;AAEFI,UAAAA,YAAY,GAAGN,MAAM,CAACU,MAAP,CAAcC,QAAd,CAAuBC,MAAtC;AACD,SAHD,CAGE,OAAOC,GAAP,EAAY;AAEZP,UAAAA,YAAY,GAAG,GAAf;AACD;;AACD,YAAI;AACF,cAAMQ,UAAU,SAASC,eAAOC,YAAP,GACtBC,EADsB,CAErBC,sBAAeC,2BAFM,EAInBC,OADF,IAEkD;AAIhD,gBAAIC,eAAJ;;AACA,gBAAID,OAAJ,EAAa;AACX,kBAAIrB,mBAAJ,EAAyB;AAGvBC,gBAAAA,MAAM,CAACsB,YAAP,CAAoBvB,mBAApB;AACAA,gBAAAA,mBAAmB,GAAGwB,SAAtB;;AACA,oBAAIlB,aAAJ,EAAmB;AACjB,sBAAI;AACFgB,oBAAAA,eAAe,GAAGhB,aAAa,CAACmB,kBAAd,CAAiCJ,OAAjC,CAAlB;AACAb,oBAAAA,WAAW,CAACc,eAAD,CAAX;AACD,mBAHD,CAGE,OAAOI,KAAP,EAAc;AAEd3B,oBAAAA,MAAM,CAAC2B,KAAD,CAAN;AACD;AACF,iBARD,MAQO;AAGL3B,kBAAAA,MAAM,CAAC,IAAII,KAAJ,CAAU,4BAAV,CAAD,CAAN;AACD;AACF,eAlBD,MAkBO;AAELmB,gBAAAA,eAAe,GAAGhB,aAAa,CAACmB,kBAAd,CAAiCJ,OAAjC,CAAlB;AACD;AACF;;AACD,mBAAOC,eAAP;AACD,WAnCoB,EAqCtBK,gBArCsB,CAqCLpB,YArCK,EAsCtBqB,kBAtCsB,CAsCHvB,aAAa,IAAI,KAtCd,EAuCtBwB,KAvCsB,GAwCtBC,OAxCsB,EAAzB;AA2CAxB,UAAAA,aAAa,GAAG,IAAIyB,wCAAJ;AACdhB,YAAAA;AADc,aAEXnB,aAFW,EAAhB;AAMA,gDAAgBU,aAAhB;AACD,SAnDD,CAmDE,OAAOoB,KAAP,EAAc;AACdzB,UAAAA,MAAM,CAACsB,YAAP,CAAoBvB,mBAApB;AACAA,UAAAA,mBAAmB,GAAGwB,SAAtB;AACAzB,UAAAA,MAAM,CAAC2B,KAAD,CAAN;AACD;AACF,OApGD;;AAAA;AAAA;AAAA;AAAA,QAJkC;AAAA,GAAH;;AAAA,kBAApB/B,oBAAoB;AAAA;AAAA;AAAA,GAA1B","sourcesContent":["/*\n\n MIT License\n\n Copyright (c) 2021 Looker Data Sciences, Inc.\n\n Permission is hereby granted, free of charge, to any person obtaining a copy\n of this software and associated documentation files (the \"Software\"), to deal\n in the Software without restriction, including without limitation the rights\n to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n copies of the Software, and to permit persons to whom the Software is\n furnished to do so, subject to the following conditions:\n\n The above copyright notice and this permission notice shall be included in all\n copies or substantial portions of the Software.\n\n THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n SOFTWARE.\n\n */\n\nimport { Chatty } from '@looker/chatty'\nimport { ExtensionHostApiImpl } from './extension_host_api'\nimport { registerHostApi } from './global_listener'\nimport type {\n  ExtensionHostApi,\n  ExtensionHostConfiguration,\n  ExtensionInitializationResponse,\n  ExtensionNotification,\n} from './types'\nimport { ExtensionEvent } from './types'\n\n/**\n * Connect extension to Looker host. React extensions using the extension-sdk-react\n * package and ExtensionProvider do not need to call this as the ExtensionProvider\n * sets up the connection.\n * @param configuration\n */\nexport const connectExtensionHost = async (\n  configuration: ExtensionHostConfiguration = {}\n): Promise<ExtensionHostApi> =>\n  // eslint-disable-next-line no-async-promise-executor\n  new Promise(async (resolve, reject) => {\n    // Timer to handle the unlikely event that an initialization message\n    // is not received from the host. If this happens it's a bug in the\n    // host code.\n    let initializationTimer: number | undefined = window.setTimeout(\n      () =>\n        reject(new Error('Failed to establish communication with Looker host')),\n      30000\n    )\n    // Legacy callback to indicate that connection is established\n    const { initializedCallback, chattyTimeout } = configuration\n    let extensionHost: ExtensionHostApi\n    let targetOrigin\n    // The initialized function replaces the need the legacy callback as it\n    // resolves/rejects the promise that now wraps the chatty promise that\n    // was originally returned.\n    const initialized = (\n      initializationResponse?: ExtensionInitializationResponse\n    ) => {\n      // An initialization response is expected but the handle notification\n      // method can return undefined.\n      if (initializationResponse) {\n        // The initialization can fail, for example, Looker host is not\n        // at the right version.\n        const { errorMessage } = initializationResponse\n        if (initializedCallback) {\n          initializedCallback(errorMessage)\n        }\n        if (errorMessage) {\n          reject(new Error(errorMessage))\n        } else {\n          resolve(extensionHost)\n        }\n      } else {\n        reject(new Error('Unexpected response from initialization'))\n      }\n    }\n    try {\n      // if extension is not sandboxed the following will succeed\n      targetOrigin = window.parent.location.origin\n    } catch (err) {\n      // failure indicates running in a sandboxed environment\n      targetOrigin = '*'\n    }\n    try {\n      const chattyHost = await Chatty.createClient()\n        .on(\n          ExtensionEvent.EXTENSION_HOST_NOTIFICATION,\n          (\n            message?: ExtensionNotification\n          ): ExtensionInitializationResponse | undefined => {\n            // Handle messages from the looker host. The first message should\n            // be an initialization message containing information about the host\n            // and host extension (looker version, extension id for example).\n            let messageResponse: ExtensionInitializationResponse | undefined\n            if (message) {\n              if (initializationTimer) {\n                // The initialization timer is present so assume this is an initialization\n                // message. The initialization timer is now cleared.\n                window.clearTimeout(initializationTimer)\n                initializationTimer = undefined\n                if (extensionHost) {\n                  try {\n                    messageResponse = extensionHost.handleNotification(message)\n                    initialized(messageResponse)\n                  } catch (error) {\n                    // Handle invalid extension host initialization failure\n                    reject(error)\n                  }\n                } else {\n                  // The extension host should be initialized if we get here\n                  // so this should never happen.\n                  reject(new Error('Extension host not created'))\n                }\n              } else {\n                // All other extension host messages\n                messageResponse = extensionHost.handleNotification(message)\n              }\n            }\n            return messageResponse\n          }\n        )\n        .withTargetOrigin(targetOrigin)\n        .withDefaultTimeout(chattyTimeout || 30000)\n        .build()\n        .connect()\n      // Create the extension host (a extension specific wrapper around the\n      // chatty host)\n      extensionHost = new ExtensionHostApiImpl({\n        chattyHost,\n        ...configuration,\n      })\n      // Register the extension host so that global event listeners can send\n      // messages to the looker host (for example beforeUnload event).\n      registerHostApi(extensionHost)\n    } catch (error) {\n      window.clearTimeout(initializationTimer)\n      initializationTimer = undefined\n      reject(error)\n    }\n  })\n"],"file":"connect_extension_host.js"}